name: RF Release (pack + verify)

on:
  push:
    branches:
      - main
      - ci/**
    paths:
      - 'staging/**'
      - 'scripts/**'
      - '.github/workflows/rf-release.yml'

  workflow_dispatch:

jobs:
  pack-runtime:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y zip zstd rsync

      #######################################################################
      # OPTIONAL HOST STUB DOWNLOAD
      # If rf-runtime-dev artifact exists, download it.
      # If not, skip silently (DO NOT fail the workflow).
      #######################################################################
      - name: Try downloading host stub runtime (optional)
        id: hoststub
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: rf-runtime-dev
          path: _host_stub/
          merge-multiple: false

      - name: Report host stub status
        run: |
          if [ -d "_host_stub" ] && [ "$(ls -A _host_stub)" ]; then
            echo "[rf/release] Host stub FOUND and will be merged."
            ls -R _host_stub
          else
            echo "[rf/release] No host stub present. Proceeding without it."
          fi

      #######################################################################
      # BUILD COMBINED RUNTIME
      #######################################################################
      - name: Prepare combined runtime
        run: |
          rm -rf rf_runtime_combined
          mkdir -p rf_runtime_combined

          echo "[rf/release] Copying Android staging..."
          rsync -a staging/rf_runtime/ rf_runtime_combined/

          if [ -d "_host_stub" ] && [ "$(ls -A _host_stub)" ]; then
            echo "[rf/release] Overlaying host stub runtime..."
            rsync -a _host_stub/ rf_runtime_combined/
          fi

      #######################################################################
      # PACK RUNTIME
      #######################################################################
      - name: Run rf_pack_runtime.sh
        run: |
          bash scripts/rf_pack_runtime.sh

      #######################################################################
      # UPLOAD RELEASE ARTIFACTS
      #######################################################################
      - name: Upload packed runtime artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rf-runtime-dev
          path: dist/*
