name: CI Guard

on:
  pull_request:
    branches: ["main", "ci/**"]
  push:
    branches: ["ci/**", "main"]

permissions:
  contents: read

concurrency:
  group: ci-guard-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      # Block direct pushes to main
      - name: Block pushes to main (require PR)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          echo "Direct pushes to main are blocked. Open a PR." >&2
          exit 1

      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Echo context
        run: |
          echo "event=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "actor=${{ github.actor }}"

      # Only guard pushes to ci/** if workflow files changed
      - name: Fail if workflow files changed on push to ci/**
        if: |
          github.event_name == 'push' &&
          startsWith(github.ref, 'refs/heads/ci/')
        run: |
          set -euo pipefail
          changed=$(git diff --name-only HEAD~1..HEAD -- .github/workflows/ || true)
          if [ -n "$changed" ]; then
            echo "Workflow changes detected on ci/**. Use a PR with CODEOWNERS review." >&2
            echo "$changed"
            exit 1
          fi

      # Optional label to bypass (for deliberate guardrail edits)
      - name: Allow override by label on PR
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "Use label 'ci-override' to bypass this guard when changing guardrails."
