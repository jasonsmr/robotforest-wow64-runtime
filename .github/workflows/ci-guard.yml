name: CI Guard

on:
  pull_request:
    branches: ["main", "ci/**"]
  push:
    branches: ["ci/**"]

permissions:
  contents: read

concurrency:
  group: ci-guard-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      # Never allow direct pushes to main (extra belt-and-suspenders)
      - name: Require PR (never push to main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          echo "Pushing directly to main is blocked. Use PRs." >&2
          exit 1

      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Echo context
        run: |
          echo "event=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "base_ref=${{ github.base_ref }}"
          echo "actor=${{ github.actor }}"

      # Optional bypass: add label "ci-override" on the PR
      - name: Detect override label
        id: override
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GH_TOKEN: ${{ github.token }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          if ! command -v gh >/dev/null; then
            sudo apt-get update && sudo apt-get install -y gh >/dev/null
          fi
          if gh pr view "$PR_URL" --json labels -q '.labels[].name' | grep -q '^ci-override$'; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi

      # Only enforce golden SHAs when targeting main (we allow ci/** to iterate)
      - name: Compare SHAs with golden
        if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' && steps.override.outputs.ok != 'true' }}
        run: |
          set -euo pipefail
          test -f .golden/files.sha256 || { echo "Golden SHA file missing; failing."; exit 1; }
          tmp=$(mktemp)
          # Recompute SHAs for all tracked files in the golden list
          while read -r path; do
            test -n "$path" || continue
            test -f "$path" && sha256sum "$path" || true
          done < <(cut -d' ' -f3- .golden/files.sha256) | sed 's| \*||' > "$tmp"
          diff -u .golden/files.sha256 "$tmp" || { echo "Drift detected."; exit 1; }
